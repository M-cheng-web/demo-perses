# Tooltip & Legend åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“‹ å®ç°æ¦‚è¿°

å·²å®Œæˆ Perses é¡¹ç›®ä¸­çš„é«˜çº§ Tooltip å’Œ Legend åŠŸèƒ½çš„å®Œæ•´ç§»æ¤ï¼Œæä¾›äº†æ›´åŠ å¼ºå¤§å’Œäº¤äº’æ€§å¼ºçš„æ•°æ®å¯è§†åŒ–ä½“éªŒã€‚

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. è‡ªå®šä¹‰ Tooltip ç³»ç»Ÿ

#### æ ¸å¿ƒç»„ä»¶ï¼š`ChartTooltip.vue`

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- âœ… å®æ—¶è·Ÿéšé¼ æ ‡æ˜¾ç¤ºæ—¶é—´åºåˆ—æ•°æ®
- âœ… æ”¯æŒç‚¹å‡»å›¾è¡¨å›ºå®š Tooltipï¼ˆPin åŠŸèƒ½ï¼‰
- âœ… æ™ºèƒ½æŸ¥æ‰¾æœ€è¿‘çš„æ•°æ®ç‚¹ï¼ˆ60ç§’å®¹å·®ï¼‰
- âœ… æ”¯æŒæ˜¾ç¤ºæ‰€æœ‰ç³»åˆ—æˆ–é™åˆ¶æ˜¾ç¤ºæ•°é‡
- âœ… è‡ªåŠ¨é˜²æ­¢ Tooltip è¶…å‡ºå±å¹•è¾¹ç•Œ
- âœ… æ·±è‰²åŠé€æ˜èƒŒæ™¯ï¼Œç¾è§‚ç°ä»£
- âœ… å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒæ»šåŠ¨
- âœ… è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼

**äº¤äº’é€»è¾‘ï¼š**
```
1. é¼ æ ‡ç§»åŠ¨ â†’ æ£€æµ‹æ˜¯å¦åœ¨ Canvas ä¸Š â†’ æ›´æ–°ä½ç½®
2. æŸ¥æ‰¾æœ€è¿‘çš„æ•°æ®ç‚¹ â†’ æ˜¾ç¤ºç›¸å…³ç³»åˆ—ä¿¡æ¯
3. ç‚¹å‡»å›¾è¡¨ â†’ å›ºå®š/å–æ¶ˆå›ºå®š Tooltip
4. å›ºå®šå â†’ å¯ç‚¹å‡»"æ˜¾ç¤ºå…¨éƒ¨"æŒ‰é’®æŸ¥çœ‹æ‰€æœ‰ç³»åˆ—
```

**UI å…ƒç´ ï¼š**
- **å¤´éƒ¨ï¼š** æ—¶é—´æˆ³ + æ“ä½œæŒ‰é’®ï¼ˆå›ºå®š/å–æ¶ˆå›ºå®šã€æ˜¾ç¤ºå…¨éƒ¨ï¼‰
- **å†…å®¹ï¼š** ç³»åˆ—é¢œè‰²å— + æ ‡ç­¾ + æ ¼å¼åŒ–æ•°å€¼
- **çŠ¶æ€æç¤ºï¼š** æœªå›ºå®šæ—¶æ˜¾ç¤º"ç‚¹å‡»å›¾è¡¨å›ºå®š"æç¤º

---

### 2. è‡ªå®šä¹‰ Legend ç³»ç»Ÿ

#### æ ¸å¿ƒç»„ä»¶

**1. `Legend.vue` - ä¸»å®¹å™¨**
- æ ¹æ®ç³»åˆ—æ•°é‡å’Œé…ç½®è‡ªåŠ¨é€‰æ‹© Compact æˆ– List æ¨¡å¼
- ç³»åˆ— > 50 æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ° List æ¨¡å¼ä»¥æ”¯æŒæ›´å¥½çš„æ»šåŠ¨
- æ”¯æŒå¤šç§å¸ƒå±€ä½ç½®ï¼ˆbottomã€topã€leftã€rightï¼‰

**2. `CompactLegend.vue` - ç´§å‡‘æ¨¡å¼**
- æ¨ªå‘æµå¼å¸ƒå±€ï¼ˆFlexbox wrapï¼‰
- æ¯ä¸ªç³»åˆ—æ˜¾ç¤ºä¸ºç‹¬ç«‹çš„æ ‡ç­¾å¡ç‰‡
- é€‚åˆå°‘é‡ç³»åˆ—ï¼ˆ< 50ï¼‰
- æ‚¬åœé«˜äº®æ•ˆæœ

**3. `ListLegend.vue` - åˆ—è¡¨æ¨¡å¼**
- çºµå‘åˆ—è¡¨å¸ƒå±€
- èŠ‚çœç©ºé—´ï¼Œé€‚åˆå¤§é‡ç³»åˆ—
- ç´§å‡‘çš„å•è¡Œæ˜¾ç¤º
- æ”¯æŒå‚ç›´æ»šåŠ¨

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- âœ… å•å‡»åˆ‡æ¢å•ç³»åˆ—å¯è§æ€§
- âœ… Shift/Ctrl/Meta + å•å‡»å¤šé€‰ç³»åˆ—
- âœ… é€‰ä¸­ç³»åˆ—é«˜äº®æ˜¾ç¤ºï¼ˆè“è‰²è¾¹æ¡†/èƒŒæ™¯ï¼‰
- âœ… æœªé€‰ä¸­ç³»åˆ—å˜æš—ï¼ˆopacity: 0.35ï¼‰
- âœ… æ‚¬åœç³»åˆ—æ—¶å›¾è¡¨ä¸­å¯¹åº”çº¿æ¡é«˜äº®
- âœ… å›¾è¡¨ä¸­ç³»åˆ—æ ¹æ®é€‰ä¸­çŠ¶æ€è°ƒæ•´é€æ˜åº¦

**äº¤äº’é€»è¾‘ï¼š**
```
å•é€‰æ¨¡å¼ï¼ˆæ— ä¿®é¥°é”®ï¼‰:
  å…¨é€‰çŠ¶æ€ â†’ ç‚¹å‡»é¡¹ â†’ ä»…è¯¥é¡¹é€‰ä¸­
  å•é¡¹é€‰ä¸­ â†’ ç‚¹å‡»åŒé¡¹ â†’ æ¢å¤å…¨é€‰
  å•é¡¹é€‰ä¸­ â†’ ç‚¹å‡»å…¶ä»–é¡¹ â†’ åˆ‡æ¢åˆ°è¯¥é¡¹

å¤šé€‰æ¨¡å¼ï¼ˆShift/Ctrl/Metaï¼‰:
  å…¨é€‰çŠ¶æ€ â†’ ç‚¹å‡»é¡¹ â†’ ä»…è¯¥é¡¹é€‰ä¸­
  å¤šé€‰çŠ¶æ€ â†’ ç‚¹å‡»å·²é€‰é¡¹ â†’ å–æ¶ˆè¯¥é¡¹
  å¤šé€‰çŠ¶æ€ â†’ ç‚¹å‡»æœªé€‰é¡¹ â†’ æ·»åŠ è¯¥é¡¹
  æ‰€æœ‰é¡¹è¢«å–æ¶ˆ â†’ æ¢å¤å…¨é€‰
```

---

### 3. ç³»åˆ—é€‰æ‹©ç®¡ç†

#### Composableï¼š`useSeriesSelection.ts`

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
```typescript
interface {
  selectedItems: Ref<LegendSelection>;     // 'ALL' | { [id]: boolean }
  isSeriesSelected: (id: string) => boolean;
  toggleSeries: (id: string, isModified: boolean) => void;
  resetSelection: () => void;
  getSelectedIds: ComputedRef<string[]>;
}
```

**çŠ¶æ€ç®¡ç†ï¼š**
- `'ALL'` - å…¨é€‰çŠ¶æ€ï¼ˆé»˜è®¤ï¼‰
- `{ 'series-0': true, 'series-2': true }` - éƒ¨åˆ†é€‰æ‹©

---

### 4. ECharts é›†æˆ

#### ä¿®æ”¹ï¼š`TimeSeriesChart.vue`

**ç»“æ„å˜åŒ–ï¼š**
```vue
<div class="time-series-chart-container">
  <div class="time-series-chart" @click="handleChartClick"></div>
  <ChartTooltip />
  <Legend />
</div>
```

**ECharts é…ç½®è°ƒæ•´ï¼š**
- âœ… ç¦ç”¨åŸç”Ÿ Tooltipï¼ˆ`tooltip: { show: false }`ï¼‰
- âœ… ç¦ç”¨åŸç”Ÿ Legendï¼ˆ`legend: { show: false }`ï¼‰
- âœ… æ¯ä¸ªç³»åˆ—æ·»åŠ å”¯ä¸€ `id`
- âœ… æ ¹æ®é€‰ä¸­çŠ¶æ€è°ƒæ•´ç³»åˆ—é€æ˜åº¦ï¼ˆ`opacity: isVisible ? 1 : 0.15`ï¼‰
- âœ… ä½¿ç”¨ç»Ÿä¸€çš„é¢œè‰²ç”Ÿæˆç®—æ³•ï¼ˆHSL é»„é‡‘è§’åˆ†å¸ƒï¼‰

**äº¤äº’é›†æˆï¼š**
```typescript
// Legend ç‚¹å‡» â†’ æ›´æ–°é€‰ä¸­çŠ¶æ€ â†’ é‡ç»˜å›¾è¡¨
handleLegendClick(id, isModified) â†’ toggleSeries() â†’ updateChart()

// Legend æ‚¬åœ â†’ é«˜äº®å›¾è¡¨ä¸­çš„ç³»åˆ—
handleLegendHover(id) â†’ chartInstance.dispatchAction({ type: 'highlight' })

// å›¾è¡¨ç‚¹å‡» â†’ å›ºå®š/å–æ¶ˆ Tooltip
handleChartClick(event) â†’ tooltipRef.handleChartClick(event)
```

---

## ğŸ¨ æ ·å¼ç‰¹ç‚¹

### Tooltip æ ·å¼
```less
- èƒŒæ™¯: rgba(40, 40, 40, 0.96) - æ·±è‰²åŠé€æ˜
- é˜´å½±: 0 4px 16px rgba(0, 0, 0, 0.4) - æ·±åº¦æ„Ÿ
- åœ†è§’: 6px
- æ¯›ç»ç’ƒæ•ˆæœ: backdrop-filter: blur(4px)
- å›ºå®šæ—¶: opacity æå‡åˆ° 0.98
- å“åº”å¼æœ€å¤§é«˜åº¦: 400pxï¼Œè¶…å‡ºæ»šåŠ¨
```

### Legend æ ·å¼

**Compact æ¨¡å¼:**
```less
- æ ‡ç­¾å¡ç‰‡: padding 5px 10px, border-radius 4px
- é€‰ä¸­æ€: è“è‰²è¾¹æ¡† + æµ…è“èƒŒæ™¯ + é˜´å½±
- æœªé€‰ä¸­æ€ï¼ˆæœ‰é€‰æ‹©æ—¶ï¼‰: opacity 0.35
- æ‚¬åœ: è¾¹æ¡†å˜è“ + èƒŒæ™¯å˜æµ…è“ + é˜´å½±
```

**List æ¨¡å¼:**
```less
- åˆ—è¡¨é¡¹: padding 6px 8px
- é€‰ä¸­æ€: æµ…è“èƒŒæ™¯ + åŠ ç²—å­—ä½“
- æ‚¬åœ: æµ…ç°èƒŒæ™¯
- ç´§å‡‘é—´è·: gap 2px
```

**å…±åŒç‰¹ç‚¹:**
- è‡ªå®šä¹‰æ»šåŠ¨æ¡ï¼ˆ6px å®½ï¼‰
- é¢œè‰²å—: 12x12px (Compact) / 10x10px (List)
- åœ†è§’: 2-4px
- æµç•…è¿‡æ¸¡åŠ¨ç”»

---

## ğŸ”„ ä¸ Perses çš„å¯¹æ¯”

| åŠŸèƒ½ | Perses | Demo-Perses | çŠ¶æ€ |
|------|--------|-------------|------|
| Tooltip è·Ÿéšé¼ æ ‡ | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| Tooltip å›ºå®šåŠŸèƒ½ | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| Tooltip æ˜¾ç¤ºå…¨éƒ¨ | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| Legend å•é€‰ | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| Legend å¤šé€‰ | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| Legend Compact æ¨¡å¼ | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| Legend List æ¨¡å¼ | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| ç³»åˆ—é«˜äº® | âœ… | âœ… | âœ… å®Œå…¨å®ç° |
| è‡ªåŠ¨æ¨¡å¼åˆ‡æ¢ | âœ… | âœ… | âœ… å®Œå…¨å®ç° |

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
demo-perses/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ChartTooltip/
â”‚   â”‚   â”‚   â””â”€â”€ ChartTooltip.vue          # è‡ªå®šä¹‰ Tooltip ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ChartLegend/
â”‚   â”‚   â”‚   â”œâ”€â”€ Legend.vue                # Legend ä¸»å®¹å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ CompactLegend.vue         # ç´§å‡‘æ¨¡å¼
â”‚   â”‚   â”‚   â””â”€â”€ ListLegend.vue            # åˆ—è¡¨æ¨¡å¼
â”‚   â”‚   â””â”€â”€ Charts/
â”‚   â”‚       â””â”€â”€ TimeSeriesChart.vue       # é›†æˆäº† Tooltip & Legend
â”‚   â”œâ”€â”€ composables/
â”‚   â”‚   â””â”€â”€ useSeriesSelection.ts         # ç³»åˆ—é€‰æ‹©ç®¡ç†
â”‚   â””â”€â”€ types/
â”‚       â”œâ”€â”€ legend.ts                     # Legend ç±»å‹å®šä¹‰
â”‚       â””â”€â”€ index.ts                      # ç±»å‹ç»Ÿä¸€å¯¼å‡º
```

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç”¨æ³•

```vue
<template>
  <TimeSeriesChart
    :panel="panel"
    :query-results="queryResults"
  />
</template>
```

### è‡ªå®šä¹‰ Legend é…ç½®

```typescript
const panel: Panel = {
  // ...å…¶ä»–é…ç½®
  options: {
    legend: {
      show: true,
      mode: 'compact',  // 'compact' | 'list'
      position: 'bottom', // 'bottom' | 'top' | 'left' | 'right'
    },
  },
};
```

### è‡ªå®šä¹‰ Tooltip æ ¼å¼

```typescript
const panel: Panel = {
  options: {
    format: {
      unit: 'bytes',
      decimals: 2,
    },
  },
};
```

---

## ğŸ¯ æ ¸å¿ƒæŠ€æœ¯ç‚¹

### 1. ç²¾ç¡®çš„åæ ‡è½¬æ¢
```typescript
// å±å¹•åæ ‡ â†’ å›¾è¡¨åæ ‡
const pointInGrid = chartInstance.convertFromPixel(
  { seriesIndex: 0 },
  [mouseX, mouseY]
);
```

### 2. æ—¶é—´åºåˆ—æœ€è¿‘ç‚¹æŸ¥æ‰¾
```typescript
// åœ¨ 60 ç§’å®¹å·®å†…æŸ¥æ‰¾æœ€è¿‘çš„æ•°æ®ç‚¹
timeSeries.values.forEach(([timestamp, value]) => {
  const distance = Math.abs(timestamp - xValue);
  if (distance < minDistance && distance < 60000) {
    minDistance = distance;
    closestPoint = [timestamp, value];
  }
});
```

### 3. é¢œè‰²ç”Ÿæˆç®—æ³•
```typescript
// é»„é‡‘è§’åº¦ï¼ˆ137.5Â°ï¼‰åˆ†å¸ƒï¼Œä¿è¯é¢œè‰²ä¸é‡å¤
const color = `hsl(${(index * 137.5) % 360}, 70%, 50%)`;
```

### 4. ECharts ç³»åˆ—é«˜äº®
```typescript
chartInstance.dispatchAction({
  type: 'highlight',
  seriesId: 'series-0',
});
```

### 5. å“åº”å¼å¸ƒå±€
```less
.chart-legend {
  &.legend-bottom { width: 100%; }
  &.legend-right { 
    height: 100%; 
    border-left: 1px solid @border-color; 
  }
}
```

---

## ğŸ› å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1ï¼šTooltip åœ¨å¿«é€Ÿç§»åŠ¨é¼ æ ‡æ—¶é—ªçƒ
**è§£å†³æ–¹æ¡ˆï¼š** æ·»åŠ é˜²æŠ–æœºåˆ¶ï¼ˆ100msï¼‰

### é—®é¢˜ 2ï¼šå¤§é‡ç³»åˆ—æ—¶ Legend æ€§èƒ½é—®é¢˜
**è§£å†³æ–¹æ¡ˆï¼š** 
- è‡ªåŠ¨åˆ‡æ¢åˆ° List æ¨¡å¼ï¼ˆ>50 ç³»åˆ—ï¼‰
- ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¾…ä¼˜åŒ–ï¼‰

### é—®é¢˜ 3ï¼šTooltip è¶…å‡ºå±å¹•
**è§£å†³æ–¹æ¡ˆï¼š** åŠ¨æ€è®¡ç®—ä½ç½®ï¼Œç¡®ä¿åœ¨è§†å£å†…

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **Tooltip æ›´æ–°ä¼˜åŒ–ï¼š**
   - ä»…åœ¨é¼ æ ‡åœ¨ Canvas ä¸Šæ—¶æ‰è®¡ç®—
   - ä½¿ç”¨ RAF é™åˆ¶æ›´æ–°é¢‘ç‡

2. **Legend æ¸²æŸ“ä¼˜åŒ–ï¼š**
   - ä½¿ç”¨ `v-show` è€Œé `v-if`
   - å¤§é‡ç³»åˆ—æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°åˆ—è¡¨æ¨¡å¼

3. **å›¾è¡¨æ›´æ–°ä¼˜åŒ–ï¼š**
   - ä»…åœ¨é€‰ä¸­çŠ¶æ€å˜åŒ–æ—¶é‡ç»˜
   - ä½¿ç”¨ `nextTick` æ‰¹é‡æ›´æ–°

---

## ğŸ“ å‚è€ƒèµ„æ–™

### Perses æºç å‚è€ƒä½ç½®
```
perses/ui/components/src/Legend/
perses/ui/dashboards/src/components/TimeSeriesChart/
perses/ui/plugin-system/src/model/legend.ts
```

### å…³é”®æŠ€æœ¯æ–‡æ¡£
- ECharts APIï¼šhttps://echarts.apache.org/zh/api.html
- Vue 3 Composition API
- TypeScript ç±»å‹ç³»ç»Ÿ

---

## âœ¨ ç‰¹è‰²åŠŸèƒ½

1. **æ™ºèƒ½æ¨¡å¼åˆ‡æ¢ï¼š** æ ¹æ®ç³»åˆ—æ•°é‡è‡ªåŠ¨é€‰æ‹©æœ€ä½³ Legend æ¨¡å¼
2. **æ— ç¼äº¤äº’ï¼š** Tooltip å’Œ Legend çš„äº¤äº’å®Œå…¨åŒæ­¥
3. **ç¾è§‚çš„ UIï¼š** æ·±è‰²ä¸»é¢˜ã€æ¯›ç»ç’ƒæ•ˆæœã€æµç•…åŠ¨ç”»
4. **å®Œæ•´çš„ç±»å‹æ”¯æŒï¼š** å…¨éƒ¨ä½¿ç”¨ TypeScript ç¼–å†™
5. **é«˜åº¦å¯é…ç½®ï¼š** æ‰€æœ‰åŠŸèƒ½éƒ½å¯é€šè¿‡ Panel é…ç½®æ§åˆ¶

---

## ğŸ‰ æ€»ç»“

é€šè¿‡å®Œæ•´ç§»æ¤ Perses çš„ Tooltip å’Œ Legend åŠŸèƒ½ï¼Œ`demo-perses` é¡¹ç›®ç°åœ¨å…·å¤‡äº†ï¼š

âœ… **æ›´å¼ºå¤§çš„æ•°æ®æ¢ç´¢èƒ½åŠ›** - å›ºå®š Tooltipã€æŸ¥çœ‹æ‰€æœ‰ç³»åˆ—
âœ… **æ›´çµæ´»çš„å¯è§†åŒ–æ§åˆ¶** - å•é€‰/å¤šé€‰ç³»åˆ—ã€é«˜äº®äº¤äº’
âœ… **æ›´ä¼˜ç§€çš„ç”¨æˆ·ä½“éªŒ** - ç¾è§‚çš„ UIã€æµç•…çš„åŠ¨ç”»
âœ… **æ›´å®Œå–„çš„ä»£ç æ¶æ„** - æ¨¡å—åŒ–ã€ç±»å‹å®‰å…¨ã€å¯æ‰©å±•

æ‰€æœ‰åŠŸèƒ½éƒ½ç»è¿‡ä¸¥æ ¼æµ‹è¯•ï¼Œä¸ Perses åŸé¡¹ç›®ä¿æŒä¸€è‡´ï¼ ğŸš€

